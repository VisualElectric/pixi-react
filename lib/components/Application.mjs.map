{"version":3,"file":"Application.mjs","sources":["../../src/components/Application.ts"],"sourcesContent":["import {\n    type Application as PixiApplication,\n    extensions as PixiExtensions,\n    TextStyle,\n} from 'pixi.js';\nimport {\n    createElement,\n    forwardRef,\n    type ForwardRefRenderFunction,\n    type MutableRefObject,\n    useCallback,\n    useEffect,\n    useRef,\n} from 'react';\nimport { createRoot } from '../core/createRoot';\nimport { roots } from '../core/roots';\nimport { processUnmountQueue } from '../helpers/processUnmountQueue';\nimport { queueForUnmount } from '../helpers/queueForUnmount';\nimport { unqueueForUnmount } from '../helpers/unqueueForUnmount';\nimport { useIsomorphicLayoutEffect } from '../hooks/useIsomorphicLayoutEffect';\nimport { type ApplicationProps } from '../typedefs/ApplicationProps';\n\nconst originalDefaultTextStyle = { ...TextStyle.defaultTextStyle };\n\n/** Creates a React root and renders a Pixi application. */\nexport const ApplicationFunction: ForwardRefRenderFunction<PixiApplication, ApplicationProps> = (\n    props,\n    forwardedRef,\n) =>\n{\n    const {\n        attachToDevTools,\n        children,\n        className,\n        defaultTextStyle,\n        extensions,\n        onInit,\n        resizeTo,\n        ...applicationProps\n    } = props;\n\n    const applicationRef: MutableRefObject<PixiApplication | null> = useRef(null);\n    const canvasRef: MutableRefObject<HTMLCanvasElement | null> = useRef(null);\n    const extensionsRef: MutableRefObject<Set<any>> = useRef(new Set());\n\n    const updateResizeTo = useCallback(() =>\n    {\n        const application = applicationRef.current;\n\n        if (application)\n        {\n            if (resizeTo)\n            {\n                if ('current' in resizeTo)\n                {\n                    if (resizeTo.current instanceof HTMLElement)\n                    {\n                        application.resizeTo = resizeTo.current;\n                    }\n                }\n                else\n                {\n                    application.resizeTo = resizeTo;\n                }\n            }\n            else\n            {\n                // @ts-expect-error Actually `resizeTo` is optional, the types are just wrong. 🤷🏻‍♂️\n                application.resizeTo = undefined;\n            }\n        }\n    }, [resizeTo]);\n\n    const handleInit = useCallback((application: PixiApplication) =>\n    {\n        processUnmountQueue();\n\n        if (forwardedRef && ('current' in forwardedRef))\n        {\n            forwardedRef.current = application;\n        }\n\n        applicationRef.current = application;\n        updateResizeTo();\n        onInit?.(application);\n\n        if (attachToDevTools)\n        {\n            const globalScope = globalThis as any;\n\n            globalScope.__PIXI_APP__ = application;\n\n            import('pixi.js').then((pixi) =>\n            {\n                globalScope.__PIXI_DEVTOOLS__ = {\n                    app: application,\n                    pixi,\n                    renderer: application.renderer,\n                    stage: application.stage,\n                };\n            });\n        }\n    }, [onInit]);\n\n    useIsomorphicLayoutEffect(() =>\n    {\n        if (extensions)\n        {\n            const extensionsToHandle = [...extensions];\n            const extensionsState = extensionsRef.current;\n\n            // Check for extensions that have been removed from the array\n            for (const extension of extensionsState.values())\n            {\n                const extensionIndex = extensionsToHandle.indexOf(extension);\n\n                // If the extension is no longer in the array, we'll remove it from Pixi.js\n                if (extensionIndex === -1)\n                {\n                    PixiExtensions.remove(extension);\n                    extensionsState.delete(extension);\n                }\n\n                // Since the extension already existed in the state, we can remove it to prevent any further handling\n                extensionsToHandle.splice(extensionIndex, 1);\n            }\n\n            // Load any remaining extensions.\n            for (const extension in extensionsToHandle)\n            {\n                PixiExtensions.add(extension);\n                extensionsState.add(extension);\n            }\n        }\n    }, [extensions]);\n\n    useIsomorphicLayoutEffect(() =>\n    {\n        const canvasElement = canvasRef.current;\n\n        if (canvasElement)\n        {\n            let root = roots.get(canvasElement);\n\n            if (!root)\n            {\n                root = createRoot(canvasElement, {}, handleInit);\n            }\n\n            root.render(children, applicationProps);\n        }\n    }, [\n        applicationProps,\n        children,\n        handleInit,\n        resizeTo,\n    ]);\n\n    useIsomorphicLayoutEffect(() =>\n    {\n        updateResizeTo();\n    }, [resizeTo]);\n\n    useIsomorphicLayoutEffect(() =>\n    {\n        if (defaultTextStyle)\n        {\n            Object.assign(TextStyle.defaultTextStyle, defaultTextStyle);\n        }\n        else\n        {\n            Object.assign(TextStyle.defaultTextStyle, originalDefaultTextStyle);\n        }\n    }, [defaultTextStyle]);\n\n    // eslint-disable-next-line consistent-return\n    useEffect(() =>\n    {\n        const canvasElement = canvasRef.current;\n\n        if (canvasElement)\n        {\n            unqueueForUnmount(canvasElement);\n\n            return () =>\n            {\n                queueForUnmount(canvasElement);\n            };\n        }\n    }, []);\n\n    return createElement('canvas', {\n        className,\n        ref: canvasRef,\n    });\n};\n\nApplicationFunction.displayName = 'Application';\n\nexport const Application = forwardRef(ApplicationFunction);\n"],"names":["extensions","PixiExtensions"],"mappings":"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"}